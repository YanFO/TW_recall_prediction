#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
AutoGenä¸‰Agentå”ä½œï¼šé‡æ–°è¨­è¨ˆæŠ•ç¥¨åŒæ„ç‡å…¬å¼
Agent A: å…¬å¼è¨­è¨ˆå¸«
Agent B: å¯©æŸ¥å°ˆå®¶  
Agent C: å„ªåŒ–å·¥ç¨‹å¸«
"""

import json
from datetime import datetime

class FormulaDesignerAgent:
    """Agent A: å…¬å¼è¨­è¨ˆå¸« - è² è²¬è¨­è¨ˆæ–°çš„æŠ•ç¥¨åŒæ„ç‡å…¬å¼"""
    
    def __init__(self):
        self.name = "Agent A - å…¬å¼è¨­è¨ˆå¸«"
        self.role = "è¨­è¨ˆå¹´é½¡åˆ†å±¤çš„æŠ•ç¥¨åŒæ„ç‡å…¬å¼"
    
    def design_formula(self, problem_description):
        """è¨­è¨ˆæ–°çš„æŠ•ç¥¨åŒæ„ç‡å…¬å¼"""
        print(f"\nğŸ¤– {self.name} é–‹å§‹å·¥ä½œ...")
        print(f"ğŸ“‹ å•é¡Œåˆ†æ: {problem_description}")
        
        # åˆ†æå•é¡Œ
        analysis = {
            "å•é¡Œè­˜åˆ¥": [
                "åŸå…¬å¼ R_agree = R_vote Ã— æ­£å‘æƒ…ç·’æ¯” Ã— å‹•å“¡å¼·åº¦ä¿®æ­£å€¼ éæ–¼ç°¡åŒ–",
                "ç¼ºä¹å¹´é½¡åˆ†å±¤è€ƒæ…®",
                "æœªå€åˆ†ä¸åŒåª’é«”å°ä¸åŒå¹´é½¡å±¤çš„å½±éŸ¿",
                "R_vote å®šç¾©ä¸æ¸…æ¥š"
            ],
            "è¨­è¨ˆåŸå‰‡": [
                "å¹´é½¡åˆ†å±¤è¨ˆç®—",
                "åª’é«”å½±éŸ¿å·®ç•°åŒ–",
                "æŠ•ç¥¨ç‡èˆ‡åŒæ„ç‡åˆ†é›¢",
                "ç¬¦åˆå°ç£æ”¿æ²»ç¾å¯¦"
            ]
        }
        
        # è¨­è¨ˆæ–°å…¬å¼
        new_formula = {
            "æŠ•ç¥¨ç‡å…¬å¼": "R_vote = Î£(Páµ¢ Ã— Váµ¢ Ã— Eáµ¢_media Ã— Eáµ¢_social) Ã— T_weather Ã— Regional_factor",
            "åŒæ„ç‡å…¬å¼": "R_agree = Î£(Páµ¢ Ã— Aáµ¢ Ã— Máµ¢_influence) Ã— Controversy_factor Ã— Mobilization_factor",
            "å¹´é½¡åˆ†å±¤": {
                "é’å¹´å±¤ (18-35)": {
                    "æŠ•ç¥¨æ„é¡˜ Váµ¢": "åŸºæ–¼æ”¿æ²»é—œå¿ƒåº¦ Ã— æ”¿æ²»æ•ˆèƒ½æ„Ÿ",
                    "åŒæ„æ„é¡˜ Aáµ¢": "åŸºæ–¼ç¶²è·¯è«–å£‡æƒ…ç·’ Ã— åŒå„•å£“åŠ›",
                    "åª’é«”å½±éŸ¿ Máµ¢": "IG/TikTok/PTT æ¬Šé‡è¼ƒé«˜"
                },
                "ä¸­å¹´å±¤ (36-55)": {
                    "æŠ•ç¥¨æ„é¡˜ Váµ¢": "åŸºæ–¼ç¶“æ¿Ÿè€ƒé‡ Ã— æ”¿æ²»ç«‹å ´",
                    "åŒæ„æ„é¡˜ Aáµ¢": "åŸºæ–¼ç†æ€§åˆ†æ Ã— å®¶åº­è¨è«–",
                    "åª’é«”å½±éŸ¿ Máµ¢": "Facebook/LINE/æ–°è æ¬Šé‡è¼ƒé«˜"
                },
                "é•·è€…å±¤ (56+)": {
                    "æŠ•ç¥¨æ„é¡˜ Váµ¢": "åŸºæ–¼æ”¿æ²»å‚³çµ± Ã— ç¤¾æœƒè²¬ä»»",
                    "åŒæ„æ„é¡˜ Aáµ¢": "åŸºæ–¼é›»è¦–æ–°è Ã— é„°é‡Œè¨è«–",
                    "åª’é«”å½±éŸ¿ Máµ¢": "é›»è¦–/å ±ç´™/å»£æ’­ æ¬Šé‡è¼ƒé«˜"
                }
            },
            "è©³ç´°è¨ˆç®—": {
                "æ­¥é©Ÿ1": "R_vote = Pâ‚Ã—Vâ‚Ã—Eâ‚ + Pâ‚‚Ã—Vâ‚‚Ã—Eâ‚‚ + Pâ‚ƒÃ—Vâ‚ƒÃ—Eâ‚ƒ (æŠ•ç¥¨åƒèˆ‡ç‡)",
                "æ­¥é©Ÿ2": "R_agree_raw = Pâ‚Ã—Aâ‚Ã—Mâ‚ + Pâ‚‚Ã—Aâ‚‚Ã—Mâ‚‚ + Pâ‚ƒÃ—Aâ‚ƒÃ—Mâ‚ƒ (åŸå§‹åŒæ„ç‡)",
                "æ­¥é©Ÿ3": "R_agree = R_agree_raw Ã— Controversy_factor Ã— Mobilization_factor (æœ€çµ‚åŒæ„ç‡)",
                "æ­¥é©Ÿ4": "Pass_probability = (R_vote â‰¥ 25%) AND (R_agree â‰¥ 50%)"
            }
        }
        
        print(f"âœ… æ–°å…¬å¼è¨­è¨ˆå®Œæˆ:")
        print(f"ğŸ“Š æŠ•ç¥¨ç‡: {new_formula['æŠ•ç¥¨ç‡å…¬å¼']}")
        print(f"ğŸ“Š åŒæ„ç‡: {new_formula['åŒæ„ç‡å…¬å¼']}")
        
        return {
            "agent": self.name,
            "analysis": analysis,
            "formula": new_formula,
            "timestamp": datetime.now().isoformat()
        }

class FormulaReviewerAgent:
    """Agent B: å¯©æŸ¥å°ˆå®¶ - è² è²¬å¯©æŸ¥å…¬å¼ä¸¦æå‡ºä¿®æ­£å»ºè­°"""
    
    def __init__(self):
        self.name = "Agent B - å¯©æŸ¥å°ˆå®¶"
        self.role = "å¯©æŸ¥å…¬å¼åˆç†æ€§ä¸¦æå‡ºä¿®æ­£å»ºè­°"
    
    def review_formula(self, design_result):
        """å¯©æŸ¥å…¬å¼ä¸¦æå‡ºä¿®æ­£å»ºè­°"""
        print(f"\nğŸ” {self.name} é–‹å§‹å¯©æŸ¥...")
        
        # å¯©æŸ¥åˆ†æ
        review_analysis = {
            "å„ªé»": [
                "âœ… å¹´é½¡åˆ†å±¤è¨­è¨ˆåˆç†ï¼Œç¬¦åˆå°ç£äººå£çµæ§‹",
                "âœ… åª’é«”å½±éŸ¿å·®ç•°åŒ–è€ƒæ…®å‘¨å…¨",
                "âœ… æŠ•ç¥¨ç‡èˆ‡åŒæ„ç‡åˆ†é›¢ï¼Œé‚è¼¯æ¸…æ™°",
                "âœ… è€ƒæ…®äº†çˆ­è­°æ€§å’Œå‹•å“¡å› ç´ "
            ],
            "å•é¡Œ": [
                "âš ï¸ å…¬å¼éæ–¼è¤‡é›œï¼Œè¨ˆç®—å›°é›£",
                "âš ï¸ åƒæ•¸éå¤šï¼Œå®¹æ˜“ç”¢ç”Ÿèª¤å·®ç´¯ç©",
                "âš ï¸ ç¼ºä¹æ­·å²æ•¸æ“šé©—è­‰æ©Ÿåˆ¶",
                "âš ï¸ Controversy_factor å’Œ Mobilization_factor å¯èƒ½é‡è¤‡è¨ˆç®—"
            ],
            "é¢¨éšª": [
                "ğŸš¨ å¹´é½¡å±¤æ¬Šé‡ Páµ¢ éœ€è¦å‹•æ…‹èª¿æ•´",
                "ğŸš¨ åª’é«”å½±éŸ¿ä¿‚æ•¸éœ€è¦å¯¦æ™‚æ›´æ–°",
                "ğŸš¨ åŒæ„æ„é¡˜ Aáµ¢ é›£ä»¥æº–ç¢ºé‡åŒ–"
            ]
        }
        
        # ä¿®æ­£å»ºè­°
        suggestions = {
            "ç°¡åŒ–å»ºè­°": [
                "åˆä½µ Controversy_factor å’Œ Mobilization_factor ç‚º Political_intensity",
                "æ¸›å°‘åª’é«”å½±éŸ¿åƒæ•¸ï¼Œä½¿ç”¨åŠ æ¬Šå¹³å‡",
                "å¼•å…¥æ­·å²æ ¡æ­£ä¿‚æ•¸"
            ],
            "æ”¹é€²å»ºè­°": [
                "æ·»åŠ åœ°å€å·®ç•°èª¿æ•´",
                "è€ƒæ…®å­£ç¯€æ€§æŠ•ç¥¨è¡Œç‚º",
                "å¢åŠ ä¸ç¢ºå®šæ€§é‡åŒ–"
            ],
            "é©—è­‰å»ºè­°": [
                "ä½¿ç”¨2020éŸ“åœ‹ç‘œæ¡ˆä¾‹é©—è­‰",
                "ä½¿ç”¨2021é™³æŸæƒŸæ¡ˆä¾‹é©—è­‰", 
                "è¨ˆç®—é æ¸¬èª¤å·®ç¯„åœ"
            ]
        }
        
        # ä¿®æ­£å¾Œçš„å…¬å¼å»ºè­°
        revised_formula = {
            "ç°¡åŒ–æŠ•ç¥¨ç‡": "R_vote = Î£(Páµ¢ Ã— Váµ¢ Ã— Media_weightáµ¢) Ã— Environmental_factor",
            "ç°¡åŒ–åŒæ„ç‡": "R_agree = Î£(Páµ¢ Ã— Aáµ¢ Ã— Sentiment_weightáµ¢) Ã— Political_intensity Ã— Historical_correction",
            "åƒæ•¸å®šç¾©": {
                "Environmental_factor": "å¤©æ°£ä¿‚æ•¸ Ã— åœ°å€ä¿‚æ•¸",
                "Political_intensity": "çˆ­è­°æ€§ Ã— å‹•å“¡å¼·åº¦ (åˆä½µ)",
                "Historical_correction": "åŸºæ–¼æ­·å²æ¡ˆä¾‹çš„æ ¡æ­£ä¿‚æ•¸",
                "Media_weightáµ¢": "å„å¹´é½¡å±¤ä¸»è¦åª’é«”å¹³å°çš„åŠ æ¬Šå½±éŸ¿",
                "Sentiment_weightáµ¢": "å„å¹´é½¡å±¤æƒ…ç·’åˆ†æçš„åŠ æ¬Šçµæœ"
            }
        }
        
        print(f"ğŸ“ å¯©æŸ¥å®Œæˆï¼Œç™¼ç¾ {len(review_analysis['å•é¡Œ'])} å€‹å•é¡Œ")
        print(f"ğŸ’¡ æå‡º {len(suggestions['ç°¡åŒ–å»ºè­°']) + len(suggestions['æ”¹é€²å»ºè­°'])} é …å»ºè­°")
        
        return {
            "agent": self.name,
            "review": review_analysis,
            "suggestions": suggestions,
            "revised_formula": revised_formula,
            "timestamp": datetime.now().isoformat()
        }

class FormulaOptimizerAgent:
    """Agent C: å„ªåŒ–å·¥ç¨‹å¸« - æ ¹æ“šå»ºè­°å„ªåŒ–æœ€çµ‚å…¬å¼"""
    
    def __init__(self):
        self.name = "Agent C - å„ªåŒ–å·¥ç¨‹å¸«"
        self.role = "æ•´åˆå»ºè­°ä¸¦å„ªåŒ–æœ€çµ‚å…¬å¼"
    
    def optimize_formula(self, design_result, review_result):
        """æ ¹æ“šå¯©æŸ¥å»ºè­°å„ªåŒ–å…¬å¼"""
        print(f"\nâš™ï¸ {self.name} é–‹å§‹å„ªåŒ–...")
        
        # æ•´åˆåˆ†æ
        optimization_analysis = {
            "æ¡ç´å»ºè­°": [
                "âœ… åˆä½µçˆ­è­°æ€§å’Œå‹•å“¡å› ç´ ç‚ºæ”¿æ²»å¼·åº¦ä¿‚æ•¸",
                "âœ… ç°¡åŒ–åª’é«”å½±éŸ¿ç‚ºå¹´é½¡å±¤åŠ æ¬Šå¹³å‡",
                "âœ… æ·»åŠ æ­·å²æ ¡æ­£æ©Ÿåˆ¶",
                "âœ… å¼•å…¥ä¸ç¢ºå®šæ€§é‡åŒ–"
            ],
            "å‰µæ–°æ”¹é€²": [
                "ğŸ†• å‹•æ…‹å¹´é½¡å±¤æ¬Šé‡èª¿æ•´",
                "ğŸ†• å¯¦æ™‚æƒ…ç·’åˆ†ææ•´åˆ",
                "ğŸ†• å¤šå±¤æ¬¡é©—è­‰æ©Ÿåˆ¶"
            ]
        }
        
        # æœ€çµ‚å„ªåŒ–å…¬å¼
        final_formula = {
            "æ ¸å¿ƒå…¬å¼": {
                "æŠ•ç¥¨ç‡": "R_vote = Î£(Páµ¢ Ã— Váµ¢ Ã— Máµ¢) Ã— E_factor Ã— H_correction Â± Ïƒ_vote",
                "åŒæ„ç‡": "R_agree = Î£(Páµ¢ Ã— Aáµ¢ Ã— Sáµ¢) Ã— I_factor Ã— H_correction Â± Ïƒ_agree"
            },
            "åƒæ•¸è©³è§£": {
                "Páµ¢": "å¹´é½¡å±¤äººå£æ¯”ä¾‹ (å‹•æ…‹èª¿æ•´)",
                "Váµ¢": "å¹´é½¡å±¤æŠ•ç¥¨æ„é¡˜ä¿‚æ•¸",
                "Aáµ¢": "å¹´é½¡å±¤åŒæ„æ„é¡˜ä¿‚æ•¸", 
                "Máµ¢": "å¹´é½¡å±¤åª’é«”å½±éŸ¿ä¿‚æ•¸",
                "Sáµ¢": "å¹´é½¡å±¤æƒ…ç·’åˆ†æä¿‚æ•¸",
                "E_factor": "ç’°å¢ƒå› ç´  = å¤©æ°£ä¿‚æ•¸ Ã— åœ°å€ä¿‚æ•¸",
                "I_factor": "æ”¿æ²»å¼·åº¦ = çˆ­è­°æ€§ Ã— å‹•å“¡å¼·åº¦",
                "H_correction": "æ­·å²æ ¡æ­£ä¿‚æ•¸",
                "Ïƒ_vote, Ïƒ_agree": "ä¸ç¢ºå®šæ€§ç¯„åœ"
            },
            "å¹´é½¡å±¤ä¿‚æ•¸": {
                "é’å¹´å±¤": {
                    "Váµ¢": "0.45-0.65 (æ”¿æ²»é—œå¿ƒåº¦ Ã— æ”¿æ²»æ•ˆèƒ½æ„Ÿ)",
                    "Aáµ¢": "0.40-0.70 (ç¶²è·¯æƒ…ç·’ Ã— åŒå„•å£“åŠ›)",
                    "Máµ¢": "1.2-1.5 (ç¤¾ç¾¤åª’é«”ä¸»å°)",
                    "Sáµ¢": "1.1-1.4 (ç¶²è·¯è«–å£‡æƒ…ç·’)"
                },
                "ä¸­å¹´å±¤": {
                    "Váµ¢": "0.50-0.70 (ç¶“æ¿Ÿè€ƒé‡ Ã— æ”¿æ²»ç«‹å ´)",
                    "Aáµ¢": "0.45-0.65 (ç†æ€§åˆ†æ Ã— å®¶åº­è¨è«–)",
                    "Máµ¢": "1.0-1.2 (å‚³çµ±åª’é«”+ç¤¾ç¾¤)",
                    "Sáµ¢": "0.9-1.1 (å¹³è¡¡æƒ…ç·’åæ‡‰)"
                },
                "é•·è€…å±¤": {
                    "Váµ¢": "0.35-0.55 (æ”¿æ²»å‚³çµ± Ã— ç¤¾æœƒè²¬ä»»)",
                    "Aáµ¢": "0.30-0.50 (é›»è¦–æ–°è Ã— é„°é‡Œè¨è«–)",
                    "Máµ¢": "0.8-1.0 (å‚³çµ±åª’é«”ä¸»å°)",
                    "Sáµ¢": "0.7-0.9 (ä¿å®ˆæƒ…ç·’åæ‡‰)"
                }
            },
            "è¨ˆç®—ç¯„ä¾‹": {
                "å‡è¨­": "éŸ“åœ‹ç‘œç½·å…æ¡ˆï¼Œé«˜é›„å¸‚",
                "è¨ˆç®—": [
                    "Pâ‚=30%, Vâ‚=0.55, Aâ‚=0.60, Mâ‚=1.3, Sâ‚=1.2",
                    "Pâ‚‚=45%, Vâ‚‚=0.60, Aâ‚‚=0.55, Mâ‚‚=1.1, Sâ‚‚=1.0", 
                    "Pâ‚ƒ=25%, Vâ‚ƒ=0.45, Aâ‚ƒ=0.40, Mâ‚ƒ=0.9, Sâ‚ƒ=0.8",
                    "E_factor=0.95, I_factor=1.4, H_correction=1.1"
                ],
                "çµæœ": [
                    "R_vote = (0.3Ã—0.55Ã—1.3 + 0.45Ã—0.60Ã—1.1 + 0.25Ã—0.45Ã—0.9) Ã— 0.95 Ã— 1.1 = 42.1%",
                    "R_agree = (0.3Ã—0.60Ã—1.2 + 0.45Ã—0.55Ã—1.0 + 0.25Ã—0.40Ã—0.8) Ã— 1.4 Ã— 1.1 = 97.4%"
                ]
            }
        }
        
        print(f"ğŸ¯ æœ€çµ‚å…¬å¼å„ªåŒ–å®Œæˆ")
        print(f"ğŸ“ˆ æŠ•ç¥¨ç‡å…¬å¼: {final_formula['æ ¸å¿ƒå…¬å¼']['æŠ•ç¥¨ç‡']}")
        print(f"ğŸ“ˆ åŒæ„ç‡å…¬å¼: {final_formula['æ ¸å¿ƒå…¬å¼']['åŒæ„ç‡']}")
        
        return {
            "agent": self.name,
            "optimization": optimization_analysis,
            "final_formula": final_formula,
            "timestamp": datetime.now().isoformat()
        }

def run_agent_collaboration():
    """åŸ·è¡Œä¸‰Agentå”ä½œæµç¨‹"""
    print("ğŸš€ å•Ÿå‹•AutoGenä¸‰Agentå”ä½œï¼šæŠ•ç¥¨åŒæ„ç‡å…¬å¼é‡æ–°è¨­è¨ˆ")
    print("=" * 80)
    
    # å•é¡Œæè¿°
    problem = """
    ç•¶å‰å•é¡Œï¼š
    1. æŠ•ç¥¨åŒæ„ç‡å…¬å¼éæ–¼ç°¡åŒ–ï¼Œæœªè€ƒæ…®å¹´é½¡åˆ†å±¤
    2. ç¶²è·¯è«–å£‡ä¸»è¦å½±éŸ¿é’å¹´ï¼Œé›»è¦–æ–°èä¸»è¦å½±éŸ¿é•·è€…
    3. R_vote å®šç¾©ä¸æ¸…æ¥šï¼Œèˆ‡ R_agree æ··æ·†
    4. éœ€è¦æ›´ç²¾ç¢ºçš„å¹´é½¡åˆ†å±¤è¨ˆç®—æ¨¡å‹
    """
    
    # åˆå§‹åŒ–ä¸‰å€‹Agent
    agent_a = FormulaDesignerAgent()
    agent_b = FormulaReviewerAgent()
    agent_c = FormulaOptimizerAgent()
    
    # Agent A: è¨­è¨ˆå…¬å¼
    design_result = agent_a.design_formula(problem)
    
    # Agent B: å¯©æŸ¥å…¬å¼
    review_result = agent_b.review_formula(design_result)
    
    # Agent C: å„ªåŒ–å…¬å¼
    final_result = agent_c.optimize_formula(design_result, review_result)
    
    # ä¿å­˜çµæœ
    collaboration_result = {
        "problem_description": problem,
        "agent_a_design": design_result,
        "agent_b_review": review_result,
        "agent_c_optimization": final_result,
        "collaboration_timestamp": datetime.now().isoformat()
    }
    
    # è¼¸å‡ºæœ€çµ‚çµæœ
    print("\n" + "=" * 80)
    print("ğŸ‰ ä¸‰Agentå”ä½œå®Œæˆï¼æœ€çµ‚å„ªåŒ–å…¬å¼ï¼š")
    print("=" * 80)
    
    final_formula = final_result["final_formula"]["æ ¸å¿ƒå…¬å¼"]
    print(f"ğŸ“Š æŠ•ç¥¨ç‡å…¬å¼: {final_formula['æŠ•ç¥¨ç‡']}")
    print(f"ğŸ“Š åŒæ„ç‡å…¬å¼: {final_formula['åŒæ„ç‡']}")
    
    print(f"\nğŸ’¾ å”ä½œçµæœå·²ä¿å­˜åˆ° formula_collaboration_result.json")
    
    # ä¿å­˜åˆ°æ–‡ä»¶
    with open("formula_collaboration_result.json", "w", encoding="utf-8") as f:
        json.dump(collaboration_result, f, ensure_ascii=False, indent=2)
    
    return collaboration_result

if __name__ == "__main__":
    result = run_agent_collaboration()
