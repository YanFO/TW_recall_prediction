# ä½¿ç”¨å®˜æ–¹Python 3.9 slimæ˜ åƒä½œç‚ºåŸºç¤
FROM python:3.9-slim

# è¨­å®šå·¥ä½œç›®éŒ„
WORKDIR /app

# è¨­å®šç’°å¢ƒè®Šæ•¸
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV TZ=Asia/Taipei

# å®‰è£ç³»çµ±ä¾è³´
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    wget \
    curl \
    unzip \
    gnupg \
    fonts-liberation \
    fonts-wqy-zenhei \
    fonts-wqy-microhei \
    fonts-noto-cjk \
    libasound2 \
    libatk-bridge2.0-0 \
    libdrm2 \
    libxkbcommon0 \
    libxss1 \
    libgconf-2-4 \
    libxrandr2 \
    libasound2 \
    libpangocairo-1.0-0 \
    libatk1.0-0 \
    libcairo-gobject2 \
    libgtk-3-0 \
    libgdk-pixbuf2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£Chromeç€è¦½å™¨ (ç”¨æ–¼Selenium) - ç°¡åŒ–ç‰ˆæœ¬ï¼Œä¸å®‰è£Chromeä»¥åŠ å¿«å»ºæ§‹
# å¦‚æœéœ€è¦SeleniumåŠŸèƒ½ï¼Œå¯ä»¥å–æ¶ˆè¨»è§£ä»¥ä¸‹è¡Œ
# RUN wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /usr/share/keyrings/googlechrome-linux-keyring.gpg \
#     && echo "deb [arch=amd64] [signed-by=/usr/share/keyrings/googlechrome-linux-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list \
#     && apt-get update \
#     && apt-get install -y google-chrome-stable \
#     && rm -rf /var/lib/apt/lists/*

# è¤‡è£½requirements.txtä¸¦å®‰è£Pythonä¾è³´
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# è¤‡è£½æ‡‰ç”¨ç¨‹å¼ä»£ç¢¼
COPY . .

# å»ºç«‹è³‡æ–™ç›®éŒ„
RUN mkdir -p /app/data /app/logs /app/output

# è¨­å®šæ¬Šé™
RUN chmod +x *.py

# æš´éœ²Streamlité è¨­ç«¯å£
EXPOSE 8501

# å»ºç«‹å•Ÿå‹•è…³æœ¬
RUN echo '#!/bin/bash\n\
echo "ğŸ—³ï¸ å°ç£ç½·å…é æ¸¬åˆ†æç³»çµ± - Dockerç‰ˆæœ¬"\n\
echo "================================"\n\
\n\
# æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰è³‡æ–™\n\
if [ ! -f "/app/data/analysis_complete.flag" ]; then\n\
    echo "ğŸ“Š é¦–æ¬¡åŸ·è¡Œï¼Œé–‹å§‹è³‡æ–™æ”¶é›†èˆ‡åˆ†æ..."\n\
    \n\
    echo "ğŸ•·ï¸ åŸ·è¡ŒPTTçˆ¬èŸ²..."\n\
    python ptt_crawler.py\n\
    \n\
    echo "ğŸ•·ï¸ åŸ·è¡ŒDcardçˆ¬èŸ²..."\n\
    python dcard_crawler.py\n\
    \n\
    echo "ğŸ˜Š åŸ·è¡Œæƒ…ç·’åˆ†æ..."\n\
    python sentiment_analyzer.py\n\
    \n\
    echo "ğŸ¯ åŸ·è¡ŒMECEåˆ†æ..."\n\
    python mece_analyzer.py\n\
    \n\
    # æ¨™è¨˜åˆ†æå®Œæˆ\n\
    touch /app/data/analysis_complete.flag\n\
    echo "âœ… åˆå§‹åˆ†æå®Œæˆï¼"\n\
else\n\
    echo "ğŸ“Š ç™¼ç¾ç¾æœ‰åˆ†æè³‡æ–™ï¼Œç›´æ¥å•Ÿå‹•Dashboard"\n\
fi\n\
\n\
echo "ğŸŒ å•Ÿå‹•Streamlit Dashboard..."\n\
echo "Dashboardå°‡åœ¨ http://localhost:8501 é–‹å•Ÿ"\n\
streamlit run dashboard.py --server.address=0.0.0.0 --server.port=8501\n\
' > /app/start.sh && chmod +x /app/start.sh

# é è¨­å‘½ä»¤
CMD ["/app/start.sh"]
